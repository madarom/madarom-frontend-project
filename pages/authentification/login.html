<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Mad'arom</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="../../assets/css/authentification.css" />
  <link rel="icon" href="/assets/img/favicon.ico" type="image/x-icon" />
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-[#fcffff]">
  <div class="w-full max-w-md">
    <div class="items-center text-center mb-6">
      <h1 class="logo-font text-2xl text-[#56b6a8]">Mad'<span class="text-[#bc1414]">arom</span></h1>
    </div>

    <div class="bg-white rounded-lg p-8 sm:p-10 shadow">

      <form id="loginForm" novalidate>
        <div class="input-container mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 input-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
          </svg>
          <input type="email" id="username" required class="input-field" placeholder="Email" autocomplete="username" />
        </div>

        <div class="input-container mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 input-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          <input type="password" id="password" required class="input-field" placeholder="Password" autocomplete="current-password" />
          <button type="button" class="toggle-password" aria-label="Afficher / Cacher mot de passe" tabindex="-1">
            <i class="fa-solid fa-eye"></i>
          </button>
        </div>

        <!-- <div class="text-right mb-6">
          <a href="/reset-password" class="text-sm text-[#56b6a8] hover:underline font-medium">Mot de passe oublié ?</a>
        </div> -->

        <button type="submit" class="btn-primary rounded-full w-full">Sign in</button>
      </form>

      <div class="mt-8 text-center">
        <p class="text-gray-500">
          Not registered yet?
          <a href="/signup" data-link class="text-[#56b6a8] font-medium">Sign up</a>
        </p>
      </div>
    </div>
  </div>

  <script type="module">
  import { getLastUrl, clearLastUrl } from '../../assets/js/url.js';

  const API_URL_LOG = 'https://madarom-project-production.up.railway.app/api/login'; 

  const form = document.getElementById("loginForm");
  const email = document.getElementById("username");
  const password = document.getElementById("password");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const btn = form.querySelector("button[type=submit]");
    btn.disabled = true;
    btn.innerHTML = "Connexion...";

    const payload = {
      email: email.value.trim(),
      password: password.value.trim()
    };

    try {
      const res = await fetch(API_URL_LOG, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        const data = await res.json();
        sessionStorage.setItem("token", data.token);

        if (data.user.role === "admin") {
          location.assign("/admin/dashboard");
        } else {

          const localCart = localStorage.getItem("cart");
          const token = sessionStorage.getItem("token");
          if (localCart) {
            const cartItems = JSON.parse(localCart);
      
            for (const cartItem of cartItems) {
              try {
                const response = await fetch("https://madarom-project-production.up.railway.app/api/cart", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                  },
                  body: JSON.stringify({
                    product_id: cartItem.product_id || cartItem.product.id, 
                    quantity: cartItem.quantity
                  })
                });
      
                if (!response.ok) {
                  const errorData = await response.json();
                  console.error("Erreur API ajout panier:", errorData);
                  alert("Erreur lors de l'ajout au panier : " + (errorData.message || "Erreur inconnue"));
                  return; 
                }

              } catch (error) {
                console.error("Erreur réseau:", error);
                alert("Erreur réseau lors de l'ajout au panier.");
                return;
              }
            }
    
            localStorage.removeItem("cart");
          }

          const lastUrl = getLastUrl();
          clearLastUrl();  
          if (lastUrl) {
            window.location.href = lastUrl; 
          } else {
            const lang = sessionStorage.getItem("lang")?.toLowerCase() || "fr";
            window.location.href = `${window.location.origin}/${lang}/`;
          }
        }
      } else {
        const error = await res.json();
        alert(error.message || "Identifiants incorrects.");
      }
    } catch (error) {
      console.error("Erreur :", error);
      alert("Une erreur est survenue.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = "Se connecter";
    }
  });

  document.querySelector(".toggle-password").addEventListener("click", () => {
    if (password.type === "password") {
      password.type = "text";
      document.querySelector(".toggle-password i").classList.replace("fa-eye", "fa-eye-slash");
    } else {
      password.type = "password";
      document.querySelector(".toggle-password i").classList.replace("fa-eye-slash", "fa-eye");
    }
  });
  </script>
</body>
</html>
