<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Validation de devis</title><script src="https://cdn.tailwindcss.com"></script><link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"><link rel="stylesheet" href="/assets/css/quote.css"><link rel="stylesheet" href="../../assets/css/style.css"><link rel="icon" href="/assets/img/favicon.ico" type="image/x-icon"></head><body class="bg-white p-6 text-gray-800 text-font-family"><div class="flex justify-between items-center max-w-6xl mx-auto mb-6"><a href="javascript:history.back()"><button class="flex items-center gap-2 text-gray-600 hover:text-[#333333] transition font-semibold"><i class="bx bx-arrow-back text-xl"></i> <span>Back</span></button></a></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-6xl mx-auto"><div class="bg-gray-50 p-8 border border-gray-200 rounded-md"><h2 class="text-xl font-semibold text-[#333333] mb-4">Validation</h2><div class="space-y-4"><div><label for="delivery-days" class="block mb-1 font-medium">Estimated Delivery (days)</label> <input type="number" id="delivery-days" placeholder="Number of days *" required min="1" value="0" class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-teal-500"></div><div><label for="delivery-hour" class="block mb-1 font-medium">Delivery Hour (optional)</label> <input type="time" id="delivery-hour" value="00:00" class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-teal-500"></div><button id="validate-btn" class="btn-primary text-white px-4 py-2 w-full rounded-md transition">Confirm Request</button></div><p id="status-message" class="mt-4 text-sm text-center"></p></div><div id="devis" class="bg-gray-50 p-8 border border-gray-200 rounded-md"><div class="flex justify-between items-center border-b pb-6 mb-6"><div class="flex flex-col gap-2"><h1 class="text-3xl font-extrabold text-[#333333] tracking-wide">QUOTE</h1><p class="text-sm text-gray-500" id="quote-number">#QTE-XXXXXX</p></div><div class="text-right"><h3 class="font-semibold mb-1">Customer :</h3><p class="text-lg font-medium" id="client-name">Name</p><p class="text-sm" id="client-email">Email</p></div></div><div class="overflow-x-auto border border-gray-200 rounded"><table class="w-full text-sm"><thead><tr class="bg-gray-100 text-[#333333] text-left"><th class="py-3 px-4 font-medium">Product</th><th class="py-3 px-4 text-center font-medium">Quantity</th><th class="py-3 px-4 text-right font-medium">Unit Price</th><th class="py-3 px-4 text-right font-medium">Total</th></tr></thead><tbody id="quotes-items" class="divide-y divide-gray-100"></tbody></table></div><div class="mt-6 flex justify-end"><div class="w-full md:w-2/3 bg-white p-4 border rounded space-y-2 shadow-sm"><div class="flex justify-between"><span class="font-medium">Sub-total:</span> <span id="subtotal">0 USD</span></div><div class="flex justify-between text-lg font-semibold text-[#333333]"><span>Total :</span> <span id="total">0 USD</span></div></div></div></div></div><div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white rounded-lg shadow-lg p-6 w-96"><h2 class="text-lg font-semibold mb-4">Confirm Quote</h2><p class="mb-6">Do you really want to confirm this quote?</p><div class="flex justify-end gap-4"><button id="cancel-btn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button> <button id="confirm-btn" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">Confirm</button></div><p id="modal-status" class="mt-4 text-center text-sm hidden"></p></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script><script>function generatePDF(){const t=document.querySelector(".max-w-3xl");html2pdf().set({margin:.5,filename:"devis.pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2},jsPDF:{unit:"in",format:"a4",orientation:"portrait"}}).from(t).save()}function formatPrice(t){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"MGA"}).format(t)}const token=sessionStorage.getItem("token"),ref=new URLSearchParams(window.location.search).get("ref");async function loadQuoteData(t){try{const e=await fetch(`https://madarom-project-production.up.railway.app/api/quote/${t}`,{headers:{Authorization:`Bearer ${token}`}});if(!e.ok)throw new Error("Devis non trouvé");const n=await e.json();document.getElementById("quote-number").textContent=`N° ${n.quote_number}`,document.getElementById("client-name").textContent=n.user.name,document.getElementById("client-email").textContent=n.user.email;const a=document.getElementById("quotes-items");let o=0;a.innerHTML="",n.items.forEach(t=>{const e=t.price_snapshot*t.quantity;o+=e,a.innerHTML+=`\n            <tr>\n              <td class="py-2 px-2">${t.product.name_en}</td>\n              <td class="py-2 px-2 text-center">${t.quantity}</td>\n              <td class="py-2 px-2 text-right">${formatPrice(t.price_snapshot)}</td>\n              <td class="py-2 px-2 text-right">${formatPrice(e)}</td>\n            </tr>`});const r=o;document.getElementById("subtotal").textContent=formatPrice(o),document.getElementById("total").textContent=formatPrice(r)}catch(t){console.error("Erreur chargement devis:",t),alert("Erreur de chargement.")}}const validateBtn=document.getElementById("validate-btn"),modal=document.getElementById("confirm-modal"),cancelBtn=document.getElementById("cancel-btn"),confirmBtn=document.getElementById("confirm-btn"),modalStatus=document.getElementById("modal-status"),statusMsg=document.getElementById("status-message");validateBtn.addEventListener("click",()=>{if(!document.getElementById("delivery-days").value)return statusMsg.textContent="Please enter the estimated delivery days.",void(statusMsg.className="text-red-500 text-sm text-center mt-2");modal.classList.remove("hidden")}),cancelBtn.addEventListener("click",()=>{modal.classList.add("hidden")}),confirmBtn.addEventListener("click",async()=>{const t=document.getElementById("delivery-days").value,e=document.getElementById("delivery-hour").value||"00:00";modalStatus.innerHTML='<span class="loader"></span> Validating...',modalStatus.classList.remove("hidden");try{const n=await fetch("https://madarom-project-production.up.railway.app/api/quote/validate",{method:"POST",headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},body:JSON.stringify({quote_request_id:ref,days:parseInt(t,10),hours:e?parseInt(e,10):0})}),a=await n.json();if(!n.ok)return modalStatus.textContent=`${a.details||a.error||"Validation error"}`,void(modalStatus.className="text-red-500 text-sm text-center mt-2");modalStatus.textContent=`${a.message||"Quote validated successfully!"}`,modalStatus.className="text-green-600 text-sm text-center mt-2",setTimeout(()=>modal.classList.add("hidden"),1500)}catch(t){console.error(t),modalStatus.textContent="Error while validating.",modalStatus.className="text-red-500 text-sm text-center mt-2"}}),ref&&token?loadQuoteData(ref):alert("Aucun ID de devis ou token manquant.")</script></body></html>