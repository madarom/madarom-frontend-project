<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Quote</title><script src="https://cdn.tailwindcss.com"></script><link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"><link rel="stylesheet" href="../../assets/css/style.css"><link rel="icon" href="/assets/img/favicon.ico" type="image/x-icon"></head><body class="bg-white p-6 text-gray-800 text-font-family"><div class="flex justify-between items-center max-w-4xl mx-auto mb-6"><a href="javascript:history.back()"><button class="flex items-center gap-2 text-gray-600 hover:text-[#333333] transition font-semibold"><i class="bx bx-arrow-back text-xl"></i> <span>Back</span></button></a><div class="flex gap-2"><button onclick="generatePDF()" class="flex items-center gap-2 btn-primary text-white px-4 py-2 rounded-full transition"><i class="bx bx-download text-xl"></i> <span>Download PDF</span></button> <button id="invoice-btn" class="hidden flex items-center gap-2 bg-yellow-500 text-white px-4 py-2 rounded-full transition hover:bg-yellow-600"><i class="bx bx-receipt text-xl"></i> <span>Invoice</span></button></div></div><div class="max-w-6xl mx-auto flex gap-6"><div id="devis" class="flex-1 max-w-4xl mx-auto bg-white p-8 border border-gray-100"><div class="flex justify-between items-center border-b pb-6 mb-6"><div class="flex flex-col gap-2"><img src="../../assets/img/logo.jpg" alt="Mad'arom logo" class="w-32 h-auto mb-2"><h1 class="text-3xl font-extrabold text-[#333333] tracking-wide">ORDER</h1><p class="text-sm text-gray-500" id="order-date"></p><p class="text-sm text-gray-500" id="quote-number">#QTE-XXXXXX</p></div><div class="text-right"><h2 class="font-semibold text-lg logo-font">Mad'arom</h2><p class="text-sm text-gray-600">Lot 73 AD Ankadikely Ilafy</p><p class="text-sm text-gray-600">+261 34 45 999 60</p><p class="text-sm text-gray-600">contact@madarom.net</p></div></div><div class="mb-6 bg-gray-50 p-4 border"><h3 class="font-medium mb-2 text-gray-700 text-lg" id="client-name">Name</h3><p class="text-sm text-gray-500" id="client-email">Email</p><p class="text-sm text-gray-500" id="client-phone"></p><p class="text-sm text-gray-500" id="client-address"></p></div><div class="overflow-x-auto border border-gray-200"><table class="w-full text-sm"><thead><tr class="bg-gray-50 text-[#333333] text-left"><th class="py-3 px-4 font-medium">Product</th><th class="py-3 px-4 text-center font-medium">Quantity</th><th class="py-3 px-4 text-right font-medium">Unit Price</th><th class="py-3 px-4 text-right font-medium">Total</th></tr></thead><tbody id="quotes-items" class="divide-y divide-gray-100"></tbody></table></div><div class="mt-6 flex justify-end"><div class="w-full md:w-1/2 bg-gray-50 p-4 border space-y-2"><div class="flex justify-between"><span class="font-medium">Sub-total:</span> <span id="subtotal">0 USD</span></div><div class="flex justify-between text-lg font-semibold text-[#333333]"><span>Total :</span> <span id="total">0 USD</span></div></div></div><div class="mt-8 text-xs text-gray-500 text-left"><p id="delivery-date"></p><p class="mt-1">Thank you for your trust!</p></div></div><div id="payment-screenshot" class="w-96 hidden"><img src="" alt="Payment Screenshot" class="w-full h-auto rounded border shadow-sm cursor-pointer" id="payment-img"></div><div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50"><img src="" alt="Payment Screenshot Enlarged" class="max-w-[90%] max-h-[90%] rounded shadow-lg" id="lightbox-img"></div></div><div id="invoice-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center px-4 z-50"><div class="bg-white rounded-xl p-6 max-w-sm w-full transition-opacity duration-300 ease-in-out opacity-100"><h2 class="text-lg font-bold text-red-600 mb-2">Confirm Invoice</h2><p class="text-sm text-gray-700 mb-4">Do you really want to generate an invoice for this order?</p><div class="flex justify-end gap-4"><button id="invoice-cancel-btn" class="px-4 py-2 rounded-full btn-default transition">Cancel</button> <button id="invoice-confirm-btn" class="px-4 py-2 rounded-full bg-red-600 hover:bg-red-700 text-white font-medium transition">Confirm</button></div><p id="invoice-status" class="mt-4 text-center text-sm hidden"></p></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script><script>function generatePDF(){const e=document.getElementById("devis"),t={margin:.5,filename:`order_${document.getElementById("quote-number").textContent.replace(/\D/g,"")}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2},jsPDF:{unit:"in",format:"a4",orientation:"portrait"}};html2pdf().set(t).from(e).save()}function formatPrice(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}const token=sessionStorage.getItem("token");token||console.warn("Aucun token trouvé dans sessionStorage");const invoiceBtn=document.getElementById("invoice-btn"),invoiceModal=document.getElementById("invoice-modal"),invoiceCancelBtn=document.getElementById("invoice-cancel-btn"),invoiceConfirmBtn=document.getElementById("invoice-confirm-btn"),invoiceStatus=document.getElementById("invoice-status");let currentQuoteId=null;async function loadQuoteData(e){try{const t=await fetch(`https://madarom-project-production.up.railway.app/api/quote/${e}`,{headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Devis non trouvé");const n=await t.json();currentQuoteId=n.quote.id,document.getElementById("order-date").textContent=`Date: ${n.quote.updated_at.split("T")[0]}`,document.getElementById("quote-number").textContent=`N° ${n.quote.reference}`,document.getElementById("client-name").textContent=n.user.name,document.getElementById("client-email").textContent=n.user.email,n.quote.payment&&(document.getElementById("client-phone").textContent=n.quote.payment.phone_number||"N/A",document.getElementById("client-address").textContent=`${n.quote.payment.city}, ${n.quote.payment.country}`);const o=document.getElementById("payment-screenshot"),i=document.getElementById("payment-img"),a=document.getElementById("lightbox"),r=document.getElementById("lightbox-img");n.quote.payment?(o.classList.remove("hidden"),i.src=`https://madarom-project-production.up.railway.app/storage/${n.quote.payment.screenshot}`,r.src=i.src,i.addEventListener("click",()=>{a.classList.remove("hidden")})):o.classList.add("hidden"),a.addEventListener("click",e=>{e.target!==a&&e.target!==r||a.classList.add("hidden")});const c=document.getElementById("quotes-items");c.innerHTML="";let d=0;n.items.forEach(e=>{const t=e.price_snapshot*e.quantity;d+=t,c.innerHTML+=`\n            <tr>\n              <td class="py-2 px-2">${e.product.name_en}</td>\n              <td class="py-2 px-2 text-center">${e.quantity}</td>\n              <td class="py-2 px-2 text-right">${formatPrice(e.price_snapshot)}</td>\n              <td class="py-2 px-2 text-right">${formatPrice(t)}</td>\n            </tr>`});const s=d;document.getElementById("subtotal").textContent=formatPrice(d),document.getElementById("total").textContent=formatPrice(s);let m=new Date(n.quote.updated_at);m=new Date(m.getFullYear(),m.getMonth(),m.getDate());let u=n.quote.day||0,l=n.quote.hours||0;(!u||0===u)&&l>0&&(u=Math.floor(l/24),l%=24);let p=new Date(m);p.setDate(p.getDate()+u),p.setHours(p.getHours()+l);let y="This order is delivered in ";u>0&&(y+=`${u} day${u>1?"s":""}`),u>0&&l>0&&(y+=" and "),l>0&&(y+=`${l} hour${l>1?"s":""}`);y+=` , on ${p.toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}`,document.getElementById("delivery-date").textContent=y,"command"===n.quote.status.toLowerCase()&&invoiceBtn.classList.remove("hidden")}catch(e){console.error("Erreur lors du chargement du devis :",e),alert("Impossible de charger le devis.")}}invoiceBtn.addEventListener("click",()=>{invoiceModal.classList.remove("hidden")}),invoiceCancelBtn.addEventListener("click",()=>{invoiceModal.classList.add("hidden"),invoiceStatus.classList.add("hidden")}),invoiceConfirmBtn.addEventListener("click",async()=>{if(currentQuoteId){invoiceStatus.classList.remove("hidden"),invoiceStatus.textContent="Processing...";try{if(!(await fetch(`https://madarom-project-production.up.railway.app/api/quote/invoice/${currentQuoteId}`,{method:"POST",headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"}})).ok)throw new Error("Invoice failed");invoiceStatus.textContent="Invoice generated successfully!",invoiceBtn.classList.add("hidden"),setTimeout(()=>invoiceModal.classList.add("hidden"),1500)}catch(e){console.error(e),invoiceStatus.textContent="Error generating invoice."}}});const params=new URLSearchParams(window.location.search),ref=params.get("ref");ref?(console.log("ID du devis :",ref),loadQuoteData(ref)):alert("Aucun ID de devis fourni.")</script></body></html>