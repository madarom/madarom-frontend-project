const API_URL="https://madarom-project-production.up.railway.app/api/products/details",productContainer=document.getElementById("product-container"),paginationContainer=document.getElementById("pagination"),detailSection=document.getElementById("product-detail");let allProducts=[],filteredProducts=[],currentPage=1;const perPage=6;let activeSubCategoryId=null;function formatPrice(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t)}async function fetchProducts(){try{const t=await fetch(API_URL),e=await t.json();allProducts=e,filteredProducts=allProducts,renderProducts(),renderPagination()}catch(t){console.error("Erreur API :",t)}}function renderProducts(){const t=6*(currentPage-1),e=filteredProducts.slice(t,t+6);productContainer.innerHTML=e.map(t=>`\n    <div \n      class="product-card bg-white rounded-2xl overflow-hidden shadow-lg transition-transform duration-300 flex flex-col hover:scale-105" \n      data-aos="fade-right"\n      style="height: 100%;"\n    >\n      \x3c!-- Image Produit --\x3e\n      <div \n        class="h-60 bg-[#f5fefc] flex items-center justify-center cursor-pointer"\n        onclick="showDetail(${t.id})"\n      >\n        <img \n          src="https://www.madarom.net/assets/${t.image_path??"assets/img/p1.png"}" \n          alt="${t.name_en}" \n          class="h-full w-full object-cover transition-opacity duration-300 hover:opacity-90"\n        >\n      </div>\n\n      \x3c!-- Contenu Texte --\x3e\n      <div class="p-6 flex flex-col flex-grow">\n        <h3 class="text-lg text-gray-900 font-bold mb-1 tracking-tight">\n          ${t.name_latin}\n        </h3>\n        <p class="text-sm text-gray-500 mb-4 leading-relaxed">\n          ${t.name_en}\n        </p>\n        \n        \x3c!-- Prix --\x3e\n        <span class="text-base font-semibold text-red mb-4">\n          ${formatPrice(t.active_price.amount)}\n        </span>\n\n        \x3c!-- Bouton Panier --\x3e\n        <div class="mt-auto">\n          <button \n            class="w-full btn-primary text-white font-medium py-2 px-4 rounded-full flex items-center justify-center gap-2 transition-colors duration-200"\n            onclick="addToCart(${t.id})"\n          >\n            <i class="fas fa-cart-plus text-lg"></i> Add to cart\n          </button>\n        </div>\n      </div>\n    </div>\n\n  `).join("")}function renderPagination(){const t=Math.ceil(filteredProducts.length/6);paginationContainer.innerHTML="";const e=document.createElement("nav");e.className="flex items-center space-x-2";const n=document.createElement("button");n.innerHTML="&laquo;",n.className="px-3 py-1 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-100",n.disabled=1===currentPage,n.addEventListener("click",()=>{currentPage>1&&(currentPage--,renderProducts(),renderPagination())}),e.appendChild(n);for(let n=1;n<=t;n++){const t=document.createElement("button");t.textContent=n,t.className="px-4 py-1 rounded-full border "+(n===currentPage?"bg-teal text-white":"border-gray-300 text-gray-600 hover:bg-gray-100"),t.addEventListener("click",()=>{currentPage=n,renderProducts(),renderPagination()}),e.appendChild(t)}const a=document.createElement("button");a.innerHTML="&raquo;",a.className="px-3 py-1 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-100",a.disabled=currentPage===t,a.addEventListener("click",()=>{currentPage<t&&(currentPage++,renderProducts(),renderPagination())}),e.appendChild(a);const r=document.createElement("div");r.className="mt-12 flex justify-center",r.appendChild(e),paginationContainer.appendChild(r)}async function addToCartStorage(t,e){const n=sessionStorage.getItem("token");if(!n){let n=JSON.parse(localStorage.getItem("cart"))||[];const a=n.find(e=>e.product_id===t.id);return a?a.quantity+=e:n.push({product_id:t.id,quantity:e}),localStorage.setItem("cart",JSON.stringify(n)),showNotification(`${t.name_latin} ajouté au panier (${e} kg)`),hideDetail(),void updateCartCount()}try{const a=await fetch("https://madarom-project-production.up.railway.app/api/cart",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({product_id:t.id,quantity:e})});if(!a.ok){const t=await a.json();return console.error("Erreur API ajout panier:",t),void alert("Erreur lors de l'ajout au panier : "+(t.message||"Erreur inconnue"))}showNotification(`${t.name_latin} ajouté au panier (${e} kg)`),hideDetail(),updateCartCount()}catch(t){console.error("Erreur réseau:",t),alert("Erreur réseau, veuillez réessayer plus tard.")}}function showNotification(t){const e=document.getElementById("toast"),n=e.querySelector("span");n&&(n.textContent=t,e.classList.remove("opacity-0","translate-y-10"),e.classList.add("opacity-100","translate-y-0"),setTimeout(()=>{e.classList.add("opacity-0","translate-y-10"),e.classList.remove("opacity-100","translate-y-0")},5e3))}async function loadCategories(){const t=document.getElementById("category-container");try{const e=await fetch("https://madarom-project-production.up.railway.app/api/categories");(await e.json()).forEach(e=>{const n=document.createElement("label");n.className="flex items-center space-x-3 cursor-pointer";const a=document.createElement("input");a.type="checkbox",a.className="form-checkbox h-5 w-5 text-teal rounded border-gray-300",a.value=e.id,a.setAttribute("data-type","category"),a.addEventListener("change",()=>{filterProducts()});const r=document.createElement("span");r.textContent=e.name,n.appendChild(a),n.appendChild(r),t.appendChild(n)})}catch(t){console.error("Erreur lors du chargement des catégorys:",t)}}async function loadSubCategories(){const t=document.getElementById("subcategory-container");try{const e=await fetch("https://madarom-project-production.up.railway.app/api/subcategories");(await e.json()).forEach(e=>{const n=document.createElement("div");n.className="filter-item p-2 rounded cursor-pointer",n.textContent=e.name,n.setAttribute("data-id",e.id),n.setAttribute("data-type","subcategory"),n.addEventListener("click",()=>{activeSubCategoryId=activeSubCategoryId===e.id?null:e.id,filterProducts(),highlightSelectedSubcategory()}),t.appendChild(n)})}catch(t){console.error("Erreur lors du chargement des sous-catégorys :",t)}}function filterProducts(){const t=Array.from(document.querySelectorAll('input[data-type="category"]:checked')).map(t=>parseInt(t.value));filteredProducts=allProducts.filter(e=>{const n=0===t.length||t.includes(e.category_id),a=!activeSubCategoryId||e.subcategory_id===activeSubCategoryId;return n&&a}),currentPage=1,renderProducts(),renderPagination()}function highlightSelectedSubcategory(){document.querySelectorAll('[data-type="subcategory"]').forEach(t=>{parseInt(t.getAttribute("data-id"))===activeSubCategoryId?t.classList.add("bg-teal","text-white"):t.classList.remove("bg-teal","text-white")})}document.addEventListener("DOMContentLoaded",fetchProducts),window.showDetail=function(t){const e=allProducts.find(e=>e.id===t);e&&(detailSection.classList.remove("hidden"),detailSection.scrollIntoView({behavior:"smooth"}),window.location.hash="#detail",detailSection.innerHTML=`\n    <div class="w-full bg-white py-12 px-6 sm:px-12 lg:px-20 rounded-3xl max-w-7xl mx-auto">\n      <div class="flex flex-col-reverse lg:flex-row items-center gap-10">\n\n        \x3c!-- Texte --\x3e\n        <div class="w-full lg:w-1/2 text-center lg:text-left">\n          <h1 class="text-3xl sm:text-4xl font-bold text-primary mb-2">${e.name_latin??"–"}</h1>\n          <h2 class="text-xl text-gray-600 mb-4">${e.name_en}</h2>\n          <p class="text-gray-700 text-base leading-relaxed mb-6">${e.description_en}</p>\n\n          \x3c!-- Prix --\x3e\n          <div class="flex flex-col w-full sm:w-auto sm:min-w-[120px] mb-10">\n            <span class="text-sm text-gray-600 font-medium mb-1">Price/kg</span>\n            <span class="text-xl font-bold text-red">\n              ${formatPrice(e.active_price.amount)}\n            </span>\n          </div>\n\n          \x3c!-- Boutons --\x3e\n          <div class="flex flex-col sm:flex-row gap-4">\n            <button \n              class="btn-primary text-white font-medium px-6 py-2 rounded-full flex items-center justify-center gap-2 transition"\n              onclick="addToCart(${e.id})">\n              <i class="fas fa-cart-plus text-lg"></i> Add to cart\n            </button>\n            \n            <button \n              class="btn-default px-6 py-2 rounded-full transition text-sm md:text-base"\n              onclick="hideDetail()">\n              Close\n            </button>\n          </div>\n        </div>\n\n        \x3c!-- Image produit --\x3e\n        <div class="w-full lg:w-1/2">\n          <div class="rounded-2xl overflow-hidden shadow-md border border-gray-200">\n            <img src="https://www.madarom.net/assets/${e.image_path??"assets/img/p1.png"}" \n                alt="${e.name_en}" \n                class="w-full h-80 sm:h-96 object-cover transition-transform duration-500 hover:scale-105">\n          </div>\n        </div>\n\n      </div>\n    </div>\n\n  `)},window.addToCart=function(t){const e=allProducts.find(e=>e.id===t);e&&(detailSection.classList.remove("hidden"),detailSection.scrollIntoView({behavior:"smooth"}),window.location.hash="#detail",detailSection.innerHTML=`\n    <div class="w-full bg-white py-12 px-6 sm:px-10 lg:px-16 max-w-7xl mx-auto">\n      <div class="flex flex-col lg:flex-row items-center gap-12">\n        \n        \x3c!-- Contenu texte --\x3e\n        <div class="w-full lg:w-1/2 text-center lg:text-left">\n          <h1 class="text-3xl sm:text-4xl font-extrabold text-primary mb-3">\n            ${e.name_latin??"–"}\n          </h1>\n          <h2 class="text-lg sm:text-xl text-gray-600 mb-4 tracking-wide">\n            ${e.name_en}\n          </h2>\n          <p class="text-gray-700 text-base sm:text-lg mb-6 leading-relaxed max-w-xl mx-auto lg:mx-0">\n            ${e.description_en}\n          </p>\n\n          \x3c!-- Section prix + quantité --\x3e\n          <div class="w-full px-6 py-6 bg-gray-50 rounded-xl shadow-inner max-w-2xl mx-auto lg:mx-0 mb-6">\n            <div class="flex flex-wrap justify-between items-center gap-6">\n            \n              \x3c!-- Prix --\x3e\n              <div class="flex flex-col w-full sm:w-auto sm:min-w-[120px]">\n                <span class="text-sm text-gray-600 font-medium mb-1">Price/kg</span>\n                <span class="text-xl font-bold text-red">\n                  ${formatPrice(e.active_price.amount)}\n                </span>\n              </div>\n\n              \x3c!-- Quantité --\x3e\n              <div class="flex flex-col w-full sm:w-auto sm:min-w-[180px]">\n                <label for="quantity" class="text-sm text-gray-600 font-medium mb-1">Quantity (kg)</label>\n                <div class="flex items-center gap-2">\n                  <button onclick="changeQuantity(-1)" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 font-bold text-lg text-gray-700">\n                    −\n                  </button>\n                  <input id="quantity" type="number" value="1" min="1"\n                    class="w-20 text-center border border-gray-300 rounded-md py-1 focus:outline-none focus:ring-2 focus:ring-emerald-500" />\n                  <button onclick="changeQuantity(1)" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 font-bold text-lg text-gray-700">\n                    +\n                  </button>\n                </div>\n              </div>\n\n            </div>\n          </div>\n\n          \x3c!-- Boutons d'action --\x3e\n          <div class="flex flex-col sm:flex-row items-center gap-4 justify-center lg:justify-start mt-4">\n            <button \n              class="w-full sm:w-auto btn-primary text-white font-semibold py-2 px-6 rounded-full flex items-center justify-center gap-2 transition duration-200"\n              onclick="handleAddToCart(${e.id})"\n            >\n              <i class="fas fa-cart-plus text-lg"></i> Add to cart\n            </button>\n\n            <button \n              class="btn-default px-6 py-2 rounded-full transition text-sm md:text-base"\n              onclick="hideDetail()">\n              Close\n            </button>\n          </div>\n        </div>\n\n        \x3c!-- Image produit --\x3e\n        <div class="w-full lg:w-1/2">\n          <div class="rounded-2xl overflow-hidden shadow-md border border-gray-200">\n            <img src="https://www.madarom.net/assets/${e.image_path??"assets/img/p1.png"}" \n                alt="${e.name_en}" \n                class="w-full h-80 sm:h-96 object-cover transition-transform duration-500 hover:scale-105">\n          </div>\n        </div>\n      </div>\n    </div>\n\n  `,updateCartCount())},window.changeQuantity=function(t){const e=document.getElementById("quantity");let n=parseInt(e.value)||1;n=Math.max(1,n+t),e.value=n},window.hideDetail=function(){const t=document.getElementById("product-detail");t&&(t.classList.add("hidden"),window.location.hash="#products")},window.handleAddToCart=function(t){addToCartStorage(allProducts.find(e=>e.id===t),parseInt(document.getElementById("quantity").value)||1)},loadCategories(),loadSubCategories();export async function updateCartCount(){const t=document.getElementById("cart-count"),e=document.getElementById("cart-count-mobile");if(!t&&!e)return;const n=sessionStorage.getItem("token");if(!n){const n=(JSON.parse(localStorage.getItem("cart"))||[]).length;return t&&(t.textContent=n),void(e&&(e.textContent=n))}try{const a=await fetch("https://madarom-project-production.up.railway.app/api/cart",{headers:{Authorization:`Bearer ${n}`}});if(!a.ok)return console.error("Erreur API récupération panier:",a.status),t&&(t.textContent="0"),void(e&&(e.textContent="0"));const r=(await a.json()).length;t&&(t.textContent=r),e&&(e.textContent=r)}catch(n){console.error("Erreur réseau récupération panier:",n),t&&(t.textContent="0"),e&&(e.textContent="0")}}updateCartCount(),window.addEventListener("storage",updateCartCount);export async function loadCategoriesToMenu(){const t=document.getElementById("products-dropdown");try{const e=await fetch("https://madarom-project-production.up.railway.app/api/categories");(await e.json()).forEach(e=>{const n=document.createElement("a");n.href="#products",n.textContent=e.name,n.className="block px-4 py-2 hover:bg-gray-100 text-black",n.setAttribute("data-category-id",e.id),n.addEventListener("click",t=>{t.preventDefault(),applyCategoryFilter(parseInt(e.id)),document.querySelector("#products").scrollIntoView({behavior:"smooth"})}),t.appendChild(n)})}catch(t){console.error("Erreur lors du chargement des catégories :",t)}}function applyCategoryFilter(t){document.querySelectorAll('input[data-type="category"]').forEach(e=>{e.checked=parseInt(e.value)===t}),activeSubCategoryId=null,filteredProducts=allProducts.filter(e=>e.category_id===t),currentPage=1,renderProducts(),renderPagination()}