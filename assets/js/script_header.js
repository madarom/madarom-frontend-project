import{updateCartCount,loadCategoriesToMenu}from"./get_api.js";document.addEventListener("DOMContentLoaded",()=>{fetch("header.html").then(e=>{if(!e.ok)throw new Error("Network response was not ok");return e.text()}).then(e=>{const t=document.getElementById("header-placeholder");if(!t)throw new Error("Missing #header-placeholder in DOM");t.innerHTML=e;const n=sessionStorage.getItem("token"),o=(document.querySelector(".btn-cart"),document.getElementById("cart-count-mobile")?.closest(".btn-cart"),document.getElementById("login-btn")),s=document.getElementById("login-btn-mobile");n?(o&&o.classList.add("hidden"),s&&s.classList.add("hidden")):(o&&o.classList.remove("hidden"),s&&s.classList.remove("hidden")),updateCartCount(),loadCategoriesToMenu(),n||console.warn("Aucun token trouvé dans sessionStorage"),fetch("https://madarom-project-production.up.railway.app/api/user-session",{method:"GET",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{const t=e.user;if(t){const e=document.getElementById("user-section"),n=document.getElementById("user-initial"),o=document.getElementById("user-email"),s=document.getElementById("user-avatar"),a=document.getElementById("user-dropdown");e&&e.classList.remove("hidden"),n&&(n.textContent=t.email.charAt(0).toUpperCase()),o&&(o.textContent=t.email),s&&a&&(s.addEventListener("click",e=>{e.stopPropagation(),a.classList.toggle("hidden")}),document.addEventListener("click",t=>{e.contains(t.target)||a.classList.add("hidden")}));const r=document.getElementById("user-section-mobile"),d=document.getElementById("user-avatar-mobile"),i=document.getElementById("user-initial-mobile"),c=document.getElementById("user-email-mobile"),l=document.getElementById("logout-btn-mobile");r&&r.classList.remove("hidden"),d&&i&&(i.textContent=t.email.charAt(0).toUpperCase()),c&&(c.textContent=t.email),l&&l.addEventListener("click",()=>{sessionStorage.removeItem("user"),location.reload()})}}).catch(e=>console.error("Erreur récupération user:",e));const a=document.getElementById("burger-menu"),r=document.getElementById("mobile-menu");a&&r&&a.addEventListener("click",()=>{r.classList.toggle("hidden")}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(!n||"#"===n)return;const o=document.querySelector(n);o&&(t.preventDefault(),window.scrollTo({top:o.offsetTop-80,behavior:"smooth"}),r?.classList.add("hidden"))})}),sessionStorage.getItem("lang")||sessionStorage.setItem("lang","EN");const d=document.getElementById("langDropdownBtn"),i=document.getElementById("langDropdownMenu"),c=document.getElementById("selected-lang");if(d&&i&&c){d.addEventListener("click",e=>{e.stopPropagation();const t=i.classList.toggle("hidden");d.setAttribute("aria-expanded",!t)}),i.querySelectorAll("button").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.lang.toUpperCase(),t=this.dataset.lang.toLowerCase();c.textContent=e,i.classList.add("hidden"),d.setAttribute("aria-expanded",!1),sessionStorage.setItem("lang",e),window.location.href=`${window.location.origin}/${t}/`})}),document.addEventListener("click",()=>{i.classList.contains("hidden")||(i.classList.add("hidden"),d.setAttribute("aria-expanded",!1))});const e=sessionStorage.getItem("lang");e&&(c.textContent=e)}const l=document.getElementById("langDropdownBtnMobile"),m=document.getElementById("langDropdownMenuMobile"),u=document.getElementById("selected-lang-mobile");if(l&&m&&u){l.addEventListener("click",e=>{e.stopPropagation();const t=m.classList.toggle("hidden");l.setAttribute("aria-expanded",!t)}),m.querySelectorAll("button").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.lang.toUpperCase(),t=this.dataset.lang.toLowerCase();u.textContent=e,m.classList.add("hidden"),l.setAttribute("aria-expanded",!1),sessionStorage.setItem("lang",e),window.location.href=`${window.location.origin}/${t}/`})}),document.addEventListener("click",()=>{m.classList.contains("hidden")||(m.classList.add("hidden"),l.setAttribute("aria-expanded",!1))});const e=sessionStorage.getItem("lang");e&&(u.textContent=e)}}).catch(e=>{console.error("Failed to load header:",e)})}),window.addEventListener("scroll",()=>{const e=document.querySelector("header"),t=document.querySelectorAll(".nav-link"),n=document.querySelector(".logo-font"),o=document.querySelector(".logo-part"),s=document.querySelector(".btn-langue"),a=document.querySelector(".btn-lang"),r=document.querySelector(".btn-cart"),d=document.querySelector(".btn-menu");e&&n&&o&&s&&r&&d&&(window.scrollY>50?(e.classList.add("bg-white","shadow-lg","translate-y-0"),e.classList.remove("bg-transparent"),n.classList.remove("text-white"),n.classList.add("text-teal"),o.classList.remove("text-white"),o.classList.add("text-red"),s.classList.remove("text-white"),s.classList.add("text-gray-900"),a.classList.remove("border-white"),a.classList.add("border-gray-900"),r.classList.remove("text-white"),r.classList.add("text-gray-900"),d.classList.remove("text-white"),d.classList.add("text-gray-900"),t.forEach(e=>{e.classList.remove("text-white"),e.classList.add("text-gray-900")})):(e.classList.add("bg-transparent"),e.classList.remove("bg-white","shadow-lg","translate-y-0"),n.classList.remove("text-teal"),n.classList.add("text-white"),o.classList.remove("text-red"),o.classList.add("text-white"),s.classList.add("text-white"),s.classList.remove("text-gray-900"),a.classList.add("border-white"),a.classList.remove("border-gray-900"),r.classList.add("text-white"),r.classList.remove("text-gray-900"),d.classList.add("text-white"),d.classList.remove("text-gray-900"),t.forEach(e=>{e.classList.remove("text-gray-900"),e.classList.add("text-white")})))}),window.toggleList=function(e){const t=e.nextElementSibling;t.classList.toggle("hidden"),t.classList.contains("hidden")?e.textContent="Learn more":e.textContent="Learn less"},window.logoutWithConfirmation=async function(){if(!window.confirm("Voulez-vous vraiment vous déconnecter ?"))return;const e=sessionStorage.getItem("token");if(e)try{const t=await fetch("https://madarom-project-production.up.railway.app/api/logout",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},credentials:"include"});if(!t.ok){const e=await t.text();throw console.error("Réponse serveur non OK:",e),new Error(`Erreur serveur ${t.status}`)}sessionStorage.removeItem("token"),alert("Déconnecté avec succès !"),location.reload()}catch(e){console.error("Erreur lors du logout :",e,e.stack),alert("Erreur lors du logout. Voir console pour détails.")}else alert("Vous êtes déjà déconnecté.")},document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("toggle-filters-btn"),t=document.getElementById("filter-panel");e&&t&&e.addEventListener("click",()=>{const n=t.classList.toggle("hidden");e.textContent=n?"Show Filters":"Hide Filters",e.setAttribute("aria-expanded",!n)})}),document.addEventListener("DOMContentLoaded",()=>{const e={"/en":"home","/en/about":"about","/en/service":"services","/en/contact":"contact","/en/products":"products"}[window.location.pathname];if(e){const t=document.getElementById(e);t&&t.scrollIntoView({behavior:"smooth"})}});