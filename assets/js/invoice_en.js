let allQuotes=[],currentPage=1;const itemsPerPage=3,tbody=document.getElementById("quotesBody"),filterDate=document.getElementById("filterDate"),sortOrder=document.getElementById("sortOrder"),pagination=document.getElementById("pagination");function renderQuotes(e){if(tbody.innerHTML="",0===e.length)return tbody.innerHTML='<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No quotes found.</td></tr>',void(pagination.innerHTML="");const t=3*(currentPage-1),n=t+3;e.slice(t,n).forEach(e=>{let t=0;e.items.forEach(e=>{t+=e.price_snapshot*e.quantity}),tbody.innerHTML+=`\n      <tr class="hover:bg-gray-50 text-[#333333]">\n        <td class="px-6 py-4 text-sm flex items-center gap-2 font-semibold">\n          <div class="w-16 h-16 flex justify-center items-center bg-gray-50 rounded-full">\n            <i class="fas fa-file-pdf text-gray-400 text-2xl"></i>\n          </div>\n          ${e.quote.reference||"N/A"}\n        </td>\n        <td class="px-6 py-4 text-lg font-semibold">${formatPrice(t)}</td>\n        <td class="px-6 py-4 text-sm">${e.quote.updated_at.split("T")[0]}</td>\n        <td class="px-6 py-4 text-sm">\n          <div class="inline-flex rounded-full overflow-hidden shadow-sm">\n            \x3c!-- Bouton gauche --\x3e\n            <button onclick="viewQuote('${e.id}')"\n              class="btn-default text-[#333333] px-3 py-1 text-sm flex items-center gap-1 rounded-l-full border-r">\n              <i class="bx bx-show"></i> View\n            </button>\n          </div>\n        </td>\n      \n      </tr>\n    `}),renderPagination(e.length)}function renderPagination(e){const t=Math.ceil(e/3);if(pagination.innerHTML="",t<=1)return;const n=document.createElement("button");n.innerHTML="&laquo;",n.disabled=1===currentPage,n.className="px-3 py-1 rounded-full "+(1===currentPage?"border border-gray-300 text-gray-600 hover:bg-gray-100 cursor-not-allowed":"border border-gray-300 text-gray-600 hover:bg-gray-100"),n.onclick=()=>{currentPage>1&&(currentPage--,applyFilters())},pagination.appendChild(n);let r=1,o=t;t>10&&(currentPage<=4?(r=1,o=5):currentPage>=t-3?(r=t-4,o=t):(r=currentPage-2,o=currentPage+2)),i(1),r>2&&s();for(let e=r;e<=o;e++)1!==e&&e!==t&&i(e);o<t-1&&s(),t>1&&i(t);const a=document.createElement("button");function i(e){const t=document.createElement("button");t.innerText=e,t.className="px-4 py-1 rounded-full border "+(e===currentPage?"bg-teal text-white":"border-gray-300 text-gray-600 hover:bg-gray-100"),t.onclick=()=>{currentPage=e,applyFilters()},pagination.appendChild(t)}function s(){const e=document.createElement("span");e.innerText="...",e.className="px-2 text-gray-500",pagination.appendChild(e)}a.innerHTML="&raquo;",a.disabled=currentPage===t,a.className="px-3 py-1 rounded-full "+(currentPage===t?"border border-gray-300 text-gray-600 hover:bg-gray-100 cursor-not-allowed":"border border-gray-300 text-gray-600 hover:bg-gray-100"),a.onclick=()=>{currentPage<t&&(currentPage++,applyFilters())},pagination.appendChild(a)}function applyFilters(){let e=[...allQuotes];const t=filterDate.value,n=sortOrder.value;t&&(e=e.filter(e=>e.created_at.startsWith(t))),e.sort((e,t)=>{const r=new Date(e.created_at),o=new Date(t.created_at);return"desc"===n?o-r:r-o}),renderQuotes(e)}async function fetchUserQuotes(){const e=sessionStorage.getItem("token");if(e)try{const t=await fetch("https://madarom-project-production.up.railway.app/api/quote/user",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch quotes.");const n=await t.json();allQuotes=n.filter(e=>"command"===e.quote.status?.toLowerCase()),applyFilters()}catch(e){console.error("Error:",e),alert("Error loading quotes.")}else alert("No token found. Please log in.")}function formatPrice(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}async function viewQuote(e){e&&(window.location.href=`/en/invoice/show?ref=${encodeURIComponent(e)}`)}filterDate.addEventListener("input",applyFilters),sortOrder.addEventListener("change",applyFilters),fetchUserQuotes(),document.addEventListener("DOMContentLoaded",()=>{const e=sessionStorage.getItem("token"),t=document.getElementById("user-menus");e&&t.classList.remove("hidden")});