let allQuotes=[],currentPage=1;const itemsPerPage=3,tbody=document.getElementById("quotesBody"),filterDate=document.getElementById("filterDate"),sortOrder=document.getElementById("sortOrder"),pagination=document.getElementById("pagination");function renderQuotes(e){if(tbody.innerHTML="",0===e.length)return tbody.innerHTML='<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No quotes found.</td></tr>',void(pagination.innerHTML="");const t=3*(currentPage-1),n=t+3;e.slice(t,n).forEach(e=>{let t=0;e.items.forEach(e=>{t+=e.price_snapshot*e.quantity}),tbody.innerHTML+=`\n      <tr class="hover:bg-gray-50 text-[#333333]">\n        <td class="px-6 py-4 text-sm flex items-center gap-2 font-semibold">\n          <div class="w-16 h-16 flex justify-center items-center bg-gray-50 rounded-full">\n            <i class="fas fa-file-pdf text-gray-400 text-2xl"></i>\n          </div>\n          ${e.quote.reference||"N/A"}\n        </td>\n        <td class="px-6 py-4 text-lg font-semibold">${formatPrice(t)}</td>\n        <td class="px-6 py-4 text-sm">${e.quote.created_at.split("T")[0]}</td>\n        <td class="px-6 py-4 text-sm">\n          <div class="inline-flex rounded-full overflow-hidden shadow-sm">\n            <button onclick="viewQuote('${e.id}')"\n              class="btn-default text-[#333333] px-3 py-1 text-sm flex items-center gap-1 rounded-l-full border-r">\n              <i class="bx bx-show"></i> View\n            </button>\n            <button onclick="openModal('order', '${e.quote.id}')"\n              class="btn-primary text-white px-3 py-1 text-sm flex items-center gap-1">\n              <i class="bx bx-cart"></i> Order\n            </button>\n            <button onclick="openModal('cancel', '${e.quote.id}')"\n              class="btn-default px-3 py-1 text-sm flex items-center gap-1 rounded-r-full border-l">\n              <i class="bx bx-trash"></i> Clear\n            </button>\n          </div>\n        </td>\n      \n      </tr>\n    `}),renderPagination(e.length)}function renderPagination(e){const t=Math.ceil(e/3);if(pagination.innerHTML="",t<=1)return;const n=document.createElement("button");n.innerHTML="&laquo;",n.disabled=1===currentPage,n.className="px-3 py-1 rounded-full "+(1===currentPage?"border border-gray-300 text-gray-600 hover:bg-gray-100 cursor-not-allowed":"border border-gray-300 text-gray-600 hover:bg-gray-100"),n.onclick=()=>{currentPage>1&&(currentPage--,applyFilters())},pagination.appendChild(n);let o=1,r=t;t>10&&(currentPage<=4?(o=1,r=5):currentPage>=t-3?(o=t-4,r=t):(o=currentPage-2,r=currentPage+2)),s(1),o>2&&c();for(let e=o;e<=r;e++)1!==e&&e!==t&&s(e);r<t-1&&c(),t>1&&s(t);const a=document.createElement("button");function s(e){const t=document.createElement("button");t.innerText=e,t.className="px-4 py-1 rounded-full border "+(e===currentPage?"bg-teal text-white":"border-gray-300 text-gray-600 hover:bg-gray-100"),t.onclick=()=>{currentPage=e,applyFilters()},pagination.appendChild(t)}function c(){const e=document.createElement("span");e.innerText="...",e.className="px-2 text-gray-500",pagination.appendChild(e)}a.innerHTML="&raquo;",a.disabled=currentPage===t,a.className="px-3 py-1 rounded-full "+(currentPage===t?"border border-gray-300 text-gray-600 hover:bg-gray-100 cursor-not-allowed":"border border-gray-300 text-gray-600 hover:bg-gray-100"),a.onclick=()=>{currentPage<t&&(currentPage++,applyFilters())},pagination.appendChild(a)}function applyFilters(){let e=[...allQuotes];const t=filterDate.value,n=sortOrder.value;t&&(e=e.filter(e=>e.created_at.startsWith(t))),e.sort((e,t)=>{const o=new Date(e.created_at),r=new Date(t.created_at);return"desc"===n?r-o:o-r}),renderQuotes(e)}async function fetchUserQuotes(){const e=sessionStorage.getItem("token");if(e)try{const t=await fetch("https://madarom-project-production.up.railway.app/api/quote/user",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch quotes.");const n=await t.json();allQuotes=n.filter(e=>"pending"===e.quote.status?.toLowerCase()),applyFilters()}catch(e){console.error("Error:",e),alert("Error loading quotes.")}else alert("No token found. Please log in.")}function formatPrice(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}async function viewQuote(e){e&&(window.location.href=`/en/quote/show?ref=${encodeURIComponent(e)}`)}async function orderQuote(e){const t=sessionStorage.getItem("token");if(t)try{showLoader(2e3);const n=await fetch(`https://madarom-project-production.up.railway.app/api/quote/order/${e}`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});await n.json().catch(()=>({}));if(!n.ok){let e={};try{e=await n.json()}catch(e){}return void console.error("Backend error:",e)}showToast("Order placed successfully!")}catch(e){console.error("Error:",e)}else alert("No token found. Please log in.")}async function clearQuote(e){const t=sessionStorage.getItem("token");if(t)try{showLoader(2e3);const n=await fetch(`https://madarom-project-production.up.railway.app/api/quote/cancel/${e}`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});await n.json().catch(()=>({}));if(!n.ok){let e={};try{e=await n.json()}catch(e){}return void console.error("Backend error:",e)}showToast("Quote cancelled successfully!")}catch(e){console.error("Error:",e),alert("Erreur rÃ©seau ou inattendue: "+e.message)}}filterDate.addEventListener("input",applyFilters),sortOrder.addEventListener("change",applyFilters),fetchUserQuotes();let selectedQuoteId=null;function openModal(e,t){selectedQuoteId=t,document.getElementById(e+"Modal").classList.remove("hidden")}function closeModal(e){document.getElementById(e).classList.add("hidden"),selectedQuoteId=null}function showLoader(e=2e3){const t=document.getElementById("loader");t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("hidden")},e)}function hideLoader(){document.getElementById("loader").classList.add("hidden")}function showToast(e="Action successful!",t=2500){const n=document.getElementById("toast");n.textContent=e,n.classList.remove("hidden"),setTimeout(()=>{n.classList.add("hidden")},t)}document.getElementById("confirmOrderBtn").addEventListener("click",async()=>{selectedQuoteId&&(await orderQuote(selectedQuoteId),closeModal("orderModal"))}),document.getElementById("confirmCancelBtn").addEventListener("click",async()=>{selectedQuoteId&&(await clearQuote(selectedQuoteId),closeModal("cancelModal"))}),document.addEventListener("DOMContentLoaded",()=>{const e=sessionStorage.getItem("token"),t=document.getElementById("user-menus");e&&t.classList.remove("hidden")});